<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Start</title>
<style>
:root {
  --bg-main: #272e33;
  --bg-surface: #2d353b;
  --bg-dark: #242b2f;
  --border: #3d484d;
  --text: #d3c6aa;
  --text-muted: #9da9a0;
  --accent: #a7c080;
  --accent-text: #1e2a23;
}

* {
  box-sizing: border-box;
  margin: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-main);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

@keyframes fadeIn {
  from { 
    opacity: 0;
    transform: translateY(-10px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.wrap {
  width: 100%;
  max-width: 680px;
  display: flex;
  flex-direction: column;
  gap: 32px;
  animation: fadeIn 0.5s ease;
}

.date-container {
  text-align: center;
  user-select: none;
}

.date {
  font-size: 18px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 6px;
}

.date-numeric {
  font-size: 14px;
  color: var(--text-muted);
  opacity: 0.7;
}

.search-input {
  width: 100%;
  padding: 18px 60px 18px 24px;
  font-size: 16px;
  background: var(--bg-surface);
  border: 2px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: inherit;
  transition: border-color 0.3s ease, background 0.3s ease;
}

.search-input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg-dark);
}

.search-input::placeholder {
  color: var(--text-muted);
}

.engine-toggle {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: -16px;
  user-select: none;
  justify-content: center;
}

.btn-toggle {
  background: var(--bg-surface);
  border: 2px solid var(--border);
  color: var(--text-muted);
  padding: 6px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-toggle:hover {
  border-color: var(--accent);
  color: var(--text);
}

.btn-toggle.active {
  background: var(--accent);
  color: var(--accent-text);
  border-color: var(--accent);
}

.shortcuts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-top: 8px;
}

.shortcut {
  background: var(--bg-surface);
  border: 2px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
  text-decoration: none;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.shortcut:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  background: var(--bg-dark);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.shortcut:hover .shortcut-icon {
  color: var(--accent);
}

.shortcut-icon {
  font-size: 24px;
  transition: color 0.2s ease;
}

.shortcut-label {
  font-size: 13px;
  font-weight: 500;
}

.hint {
  text-align: center;
  font-size: 11px;
  color: var(--text-muted);
  opacity: 0.6;
  margin-top: 24px;
  user-select: none;
}

kbd {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 6px;
  font-family: 'Courier New', monospace;
  font-size: 10px;
  color: var(--text);
  opacity: 0.8;
}

.settings-btn {
  position: absolute;
  right: 24px;
  top: 17px;
  background: transparent;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  opacity: 0.6;
  transition: color 0.2s ease, opacity 0.2s ease;
}

.settings-btn:hover {
  color: var(--accent);
  opacity: 1;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow: visible;
  animation: slideUp 0.2s ease;
  display: flex;
  flex-direction: column;
}

.modal-scrollable {
  overflow-y: auto;
  overflow-x: hidden;
  max-height: calc(90vh - 40px);
  padding-right: 4px;
  margin-right: -4px;
  scrollbar-width: none;
}

.modal-scrollable::-webkit-scrollbar {
  display: none;
}

.modal-title {
  text-align: center;
  font-weight: 700;
  font-size: 20px;
  color: var(--accent);
  margin-bottom: 20px;
}

.field {
  margin-bottom: 14px;
}

.field label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 13px;
}

.field input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  background: var(--bg-dark);
  border: 2px solid var(--border);
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
}

.field.has-icon-picker input {
  padding-right: 40px;
}

.field input:focus {
  outline: none;
  border-color: var(--accent);
}

.field input::placeholder {
  color: var(--text-muted);
}

.btn {
  background: var(--accent);
  color: var(--accent-text);
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.btn:hover {
  filter: brightness(1.05);
}

.btn-secondary {
  background: var(--bg-surface);
  border: 2px solid var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  filter: none;
  border-color: var(--accent);
}

.shortcut-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.shortcut-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg-dark);
  border: 2px solid var(--border);
  border-radius: 8px;
  transition: border-color 0.2s ease;
}

.shortcut-item:hover {
  border-color: var(--accent);
}

.shortcut-item:hover .shortcut-item-icon {
  color: var(--accent);
}

.shortcut-item-icon {
  font-size: 20px;
  width: 28px;
  text-align: center;
  transition: color 0.2s ease;
}

.shortcut-item-label {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.shortcut-item-actions {
  display: flex;
  gap: 4px;
}

.settings-section {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.settings-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.settings-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 12px;
}

.btn-icon-small {
  width: 32px;
  height: 32px;
  padding: 0;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 16px;
}

.btn-icon-small:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.btn-icon-small.delete:hover {
  border-color: #e67e80;
  color: #e67e80;
}

.context-menu {
  position: fixed;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  min-width: 180px;
  display: none;
}

.context-menu.show {
  display: block;
}

.context-menu-item {
  padding: 8px 16px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
  transition: background 0.15s ease;
}

.context-menu-item:hover {
  background: var(--bg-dark);
}

.context-menu-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.context-menu-item.disabled:hover {
  background: transparent;
}

.context-menu-divider,
.icon-picker-divider {
  height: 1px;
  background: var(--border);
  margin: 4px 0;
}

.icon-picker-divider {
  margin: 16px 0;
}

.icons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
  gap: 8px;
  margin-top: 16px;
}

.icon-tile {
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.15s ease;
}

.icon-tile:hover {
  background: var(--border);
}

.icon-picker-toggle {
  position: absolute;
  right: 6px;
  top: 31px;
  width: 28px;
  height: 28px;
  background: transparent;
  border: none;
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  transition: color 0.2s ease;
}

.icon-picker-toggle:hover {
  color: var(--accent);
}

.icon-picker-toggle.active {
  transform: rotate(180deg);
}

.icon-picker-panel {
  margin-bottom: 14px;
  padding: 12px;
  background: var(--bg-dark);
  border: 2px solid var(--border);
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  scrollbar-width: none;
}

.icon-picker-panel::-webkit-scrollbar {
  display: none;
}

.icon-picker-section {
  margin-bottom: 12px;
}

.icon-picker-section:last-child {
  margin-bottom: 0;
}

.icon-picker-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.hidden {
  display: none;
}

.shortcut-item-no-icon .shortcut-item-icon {
  display: none;
}

@media (max-width: 600px) {
  .shortcuts {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
  
  .shortcut {
    padding: 12px;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="date-container">
    <div class="date" id="date">Loading...</div>
    <div class="date-numeric" id="dateNumeric">Loading...</div>
  </div>

  <form id="searchForm" style="position: relative;">
    <input 
      type="text" 
      class="search-input" 
      id="searchInput"
      placeholder="Search or enter URL..."
      autocomplete="off"
      spellcheck="false"
    >
    <button type="button" class="settings-btn" id="settingsBtn" title="Manage Shortcuts">âš™</button>
  </form>
  
  <div class="engine-toggle" id="engineToggle">
    <button type="button" class="btn-toggle" data-engine="google">Google</button>
    <button type="button" class="btn-toggle active" data-engine="duckduckgo">DuckDuckGo</button>
    <button type="button" class="btn-toggle" data-engine="github">GitHub</button>
  </div>
  
  <div class="shortcuts" id="shortcuts"></div>
  
  <div class="hint">Press <kbd>/</kbd> to focus search â€¢ <kbd>Esc</kbd> to clear</div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-title">Settings</div>
    
    <div class="modal-scrollable">
      <div class="settings-section">
        <div class="settings-section-title">Shortcuts</div>
        <div class="shortcut-list" id="shortcutList"></div>
        
        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
          <button class="btn" id="addShortcutBtn">+ Add Shortcut</button>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Search Engines</div>
        <div class="shortcut-list" id="engineList"></div>
        
        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
          <button class="btn" id="addEngineBtn">+ Add Engine</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="editShortcutModal">
  <div class="modal-content">
    <div class="modal-title" id="editModalTitle">Add Shortcut</div>
    
    <div class="modal-scrollable">
      <div class="field has-icon-picker" style="position: relative;">
        <label>Icon</label>
        <input type="text" id="editIcon" placeholder="Pick or type an emoji/symbol">
        <button type="button" class="icon-picker-toggle" id="iconPickerToggle">â–¼</button>
      </div>
      
      <div class="icon-picker-panel hidden" id="iconPickerPanel">
        <div class="icon-picker-section">
          <div class="icon-picker-label">Emojis</div>
          <div class="icons-grid" id="emojiGrid"></div>
        </div>
        
        <div class="icon-picker-divider"></div>
        
        <div class="icon-picker-section">
          <div class="icon-picker-label">Symbols</div>
          <div class="icons-grid" id="symbolsGrid"></div>
        </div>
      </div>
      
      <div class="field">
        <label>Label</label>
        <input type="text" id="editLabel" placeholder="e.g., GitHub">
      </div>
      
      <div class="field">
        <label>URL</label>
        <input type="text" id="editUrl" placeholder="e.g., https://github.com">
      </div>
      
      <div style="display: flex; gap: 8px; justify-content: center;">
        <button class="btn" id="saveShortcutBtn">Save</button>
        <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="context-menu" id="contextMenu"></div>

<div class="modal" id="deleteModal">
  <div class="modal-content" style="max-width: 400px;">
    <div class="modal-title">Delete Item</div>
    <div style="text-align: center; margin-bottom: 20px; font-size: 14px; color: var(--text-muted);">
      Are you sure you want to delete this item?
    </div>
    <div style="display: flex; gap: 8px; justify-content: center;">
      <button class="btn" id="confirmDeleteBtn" style="background: #e67e80;">Delete</button>
      <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="editEngineModal">
  <div class="modal-content">
    <div class="modal-title" id="editEngineModalTitle">Add Engine</div>
    
    <div class="modal-scrollable">
      <div class="field">
        <label>Name</label>
        <input type="text" id="editEngineName" placeholder="e.g., Google">
      </div>
      
      <div class="field">
        <label>Search URL</label>
        <input type="text" id="editEngineUrl" placeholder="e.g., https://www.google.com/search?q=">
      </div>
      
      <div style="display: flex; gap: 8px; justify-content: center;">
        <button class="btn" id="saveEngineBtn">Save</button>
        <button class="btn btn-secondary" id="cancelEditEngineBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
const shortcuts = [
  { label: 'GitHub', icon: 'âŒ¨', url: 'https://github.com' },
  { label: 'YouTube', icon: 'â–¶', url: 'https://youtube.com' },
  { label: 'Twitch', icon: 'â—‰', url: 'https://twitch.tv' },
  { label: 'Seelen Profile', icon: 'âœŽ', url: 'https://k-ivy.github.io/Seelen-UI-Resources/' }
];

const defaultEngines = [
  { name: 'google', label: 'Google', url: 'https://www.google.com/search?q=' },
  { name: 'duckduckgo', label: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=' },
  { name: 'github', label: 'GitHub', url: 'https://github.com/search?q=' }
];

const icons = {
  emojis: [
    'ðŸ“','ðŸ“‚','ðŸ“Œ','ðŸ“Ž','ðŸ“„','ðŸ“•','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ“–','ðŸ“°','ðŸ“¤','ðŸ“¥','ðŸ“¬',
    'ðŸ“©','ðŸ“§','ðŸ’Œ','ðŸ”','ðŸ”Ž','ðŸ”—','ðŸŒ','â“','ðŸ“†','âŒ›','ðŸ•“','ðŸŒ¡','ðŸ“ˆ','ðŸ“‰',
    'ðŸ’»','ðŸ’¾','ðŸ’¿','ðŸ“€','âš™ï¸','ðŸ› ï¸','ðŸ”','ðŸ”’','ðŸªŸ','ðŸ””','ðŸ”Š','ðŸ“¢','ðŸŽµ','ðŸŽ¬',
    'ðŸ“·','ðŸ”´','ðŸŸ ','ðŸŸ¡','ðŸŸ¢','ðŸ”µ','ðŸŸ£','âšªï¸','ðŸŸ¥','ðŸŸ§','ðŸŸ¨','ðŸŸ©','ðŸŸ¦','ðŸŸª',
    'â¬œï¸','ðŸ’¬','ðŸ’–','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ©µ','ðŸ’œ','ðŸ¤','ðŸ’ª','ðŸ§ ','ðŸ«¶','âœ¨',
    'ðŸ’«','â­','ðŸ”¥','ðŸš€','â™»ï¸','ðŸŒ¸','â˜•','ðŸº','ðŸ·','ðŸ¾','ðŸ¥‚','ðŸŒ','ðŸ ','ðŸ¢',
    'ðŸ¥','ðŸ¦','ðŸ­','â›º','ðŸš‚','ðŸš„','ðŸš•','ðŸ›«','ðŸŽ‰','ðŸŽ²','ðŸª¿','ðŸ¦â€â¬›','ðŸª½','ðŸª©'
  ],
  symbols: [
    'âŒ¨','â–¶','â—‰','âš™','â˜…','â™ ','â™¥','â—†','ï¼ ','ðŸŒ¡','ðŸ—’','ðŸ—“','ðŸ—º','â˜¢','â˜½','â˜¾',
    'â„','â™ª','â™¬','â˜€','â˜','ðŸŒ¤','â˜‚','â˜„','âœ¿','â¤','â–','â™œ','âš‚','ðŸ› ','â¬¤','â—•',
    'â‚','â—ˆ','âˆ´','âˆµ','âˆ·','â§‰','âœ‚','ÏŸ','â™¨','â™•'
  ]
};

const loadFromStorage = (key, defaultValue) => {
  try {
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : defaultValue;
  } catch {
    return defaultValue;
  }
};

const saveToStorage = (key, value) => {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch {}
};

let currentShortcuts = loadFromStorage('startpage-shortcuts', shortcuts);
let currentEngines = loadFromStorage('startpage-engines', defaultEngines);
let currentEdit = { type: null, index: -1 };

let currentContextType = null;
let currentContextData = null;

const el = {
  date: document.getElementById('date'),
  dateNumeric: document.getElementById('dateNumeric'),
  searchInput: document.getElementById('searchInput'),
  searchForm: document.getElementById('searchForm'),
  shortcuts: document.getElementById('shortcuts'),
  shortcutList: document.getElementById('shortcutList'),
  engineList: document.getElementById('engineList'),
  engineToggle: document.getElementById('engineToggle'),
  editModalTitle: document.getElementById('editModalTitle'),
  editIcon: document.getElementById('editIcon'),
  editLabel: document.getElementById('editLabel'),
  editUrl: document.getElementById('editUrl'),
  editEngineModalTitle: document.getElementById('editEngineModalTitle'),
  editEngineName: document.getElementById('editEngineName'),
  editEngineUrl: document.getElementById('editEngineUrl'),
  iconPickerToggle: document.getElementById('iconPickerToggle'),
  iconPickerPanel: document.getElementById('iconPickerPanel'),
  contextMenu: document.getElementById('contextMenu'),
  settingsModal: document.getElementById('settingsModal'),
  editShortcutModal: document.getElementById('editShortcutModal'),
  editEngineModal: document.getElementById('editEngineModal'),
  deleteModal: document.getElementById('deleteModal')
};

let activeEngine = currentEngines.length > 0 ? currentEngines[0].name : 'duckduckgo';

const getEngineUrl = (name) => {
  const engine = currentEngines.find(e => e.name === name);
  return engine ? engine.url : '';
};

const getBaseUrl = (url) => url.split('?')[0];

const escapeHtml = (str) => {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
};

const escapeData = (obj, keys) => {
  const escaped = {};
  keys.forEach(key => {
    escaped[key] = escapeHtml(obj[key] || '');
  });
  return escaped;
};

const buildShortcuts = () => {
  el.shortcuts.innerHTML = currentShortcuts.map((s, i) => {
    const e = escapeData(s, ['icon', 'label', 'url']);
    return `
      <a href="${e.url}" class="shortcut" data-url="${e.url}" data-index="${i}">
        <div class="shortcut-icon">${e.icon}</div>
        <div class="shortcut-label">${e.label}</div>
      </a>
    `;
  }).join('');
};

const buildShortcutItem = (s, i) => {
  const e = escapeData(s, ['icon', 'label']);
  return `
    <div class="shortcut-item">
      <div class="shortcut-item-icon">${e.icon}</div>
      <div class="shortcut-item-label">${e.label}</div>
      <div class="shortcut-item-actions">
        <button class="btn-icon-small edit" data-index="${i}" title="Edit">âœŽ</button>
        <button class="btn-icon-small delete" data-index="${i}" title="Delete">âœ•</button>
      </div>
    </div>
  `;
};

const buildEngineItem = (eng, i) => {
  const e = escapeData(eng, ['label']);
  return `
    <div class="shortcut-item shortcut-item-no-icon">
      <div class="shortcut-item-label">${e.label}</div>
      <div class="shortcut-item-actions">
        <button class="btn-icon-small edit-engine" data-index="${i}" title="Edit">âœŽ</button>
        <button class="btn-icon-small delete delete-engine" data-index="${i}" title="Delete">âœ•</button>
      </div>
    </div>
  `;
};

const buildShortcutList = () => {
  el.shortcutList.innerHTML = currentShortcuts.map(buildShortcutItem).join('');
};

const buildEngineList = () => {
  el.engineList.innerHTML = currentEngines.map(buildEngineItem).join('');
};

const rebuildEngineToggles = () => {
  el.engineToggle.innerHTML = currentEngines.map(e => {
    const escaped = escapeData(e, ['name', 'label']);
    return `<button type="button" class="btn-toggle${e.name === activeEngine ? ' active' : ''}" data-engine="${escaped.name}">${escaped.label}</button>`;
  }).join('');
};

const openEditEngineModal = (index = -1) => {
  currentEdit = { type: 'engine', index };
  
  el.editEngineModalTitle.textContent = index >= 0 ? 'Edit Engine' : 'Add Engine';
  
  if (index >= 0) {
    const engine = currentEngines[index];
    el.editEngineName.value = engine.label;
    el.editEngineUrl.value = engine.url;
  } else {
    el.editEngineName.value = '';
    el.editEngineUrl.value = '';
  }
  
  el.editEngineModal.classList.add('show');
};

const openEditModal = (index = -1) => {
  currentEdit = { type: 'shortcut', index };
  
  el.iconPickerPanel.classList.add('hidden');
  el.iconPickerToggle.classList.remove('active');
  
  el.editModalTitle.textContent = index >= 0 ? 'Edit Shortcut' : 'Add Shortcut';
  
  if (index >= 0) {
    const shortcut = currentShortcuts[index];
    el.editIcon.value = shortcut.icon;
    el.editLabel.value = shortcut.label;
    el.editUrl.value = shortcut.url;
  } else {
    el.editIcon.value = '';
    el.editLabel.value = '';
    el.editUrl.value = '';
  }
  
  el.editShortcutModal.classList.add('show');
};

const saveItem = (type) => {
  if (type === 'shortcut') {
    const icon = el.editIcon.value.trim();
    const label = el.editLabel.value.trim();
    const url = el.editUrl.value.trim();
    
    if (!icon || !label || !url) return;
    
    const item = { icon, label, url };
    
    if (currentEdit.index >= 0) {
      currentShortcuts[currentEdit.index] = item;
    } else {
      currentShortcuts.push(item);
    }
    
    saveToStorage('startpage-shortcuts', currentShortcuts);
    buildShortcuts();
    buildShortcutList();
    el.editShortcutModal.classList.remove('show');
  } else if (type === 'engine') {
    const label = el.editEngineName.value.trim();
    const url = el.editEngineUrl.value.trim();
    
    if (!label || !url) return;
    
    const name = label.toLowerCase().replace(/[^a-z0-9]/g, '');
    const item = { name, label, url };
    
    if (currentEdit.index >= 0) {
      const oldName = currentEngines[currentEdit.index].name;
      currentEngines[currentEdit.index] = item;
      if (activeEngine === oldName) {
        activeEngine = name;
      }
    } else {
      currentEngines.push(item);
    }
    
    saveToStorage('startpage-engines', currentEngines);
    buildEngineList();
    rebuildEngineToggles();
    el.editEngineModal.classList.remove('show');
  }
};

const deleteItem = () => {
  if (currentEdit.type === 'shortcut' && currentEdit.index >= 0) {
    currentShortcuts.splice(currentEdit.index, 1);
    saveToStorage('startpage-shortcuts', currentShortcuts);
    buildShortcuts();
    buildShortcutList();
  } else if (currentEdit.type === 'engine' && currentEdit.index >= 0) {
    const deletedName = currentEngines[currentEdit.index].name;
    currentEngines.splice(currentEdit.index, 1);
    
    if (activeEngine === deletedName && currentEngines.length > 0) {
      activeEngine = currentEngines[0].name;
    }
    
    saveToStorage('startpage-engines', currentEngines);
    buildEngineList();
    rebuildEngineToggles();
  }
  
  currentEdit = { type: null, index: -1 };
  el.deleteModal.classList.remove('show');
};

const updateDate = () => {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  el.date.textContent = now.toLocaleDateString('en-US', options);
  el.dateNumeric.textContent = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()}`;
};

const isUrl = str => /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/.*)?$/i.test(str) || str.includes('localhost');

const allModals = [el.settingsModal, el.editShortcutModal, el.deleteModal, el.editEngineModal, el.contextMenu];
const closeAllModals = () => allModals.forEach(m => m.classList.remove('show'));

const contextMenuItems = {
  edit: { label: 'Edit', id: 'contextEdit' },
  open: { label: 'Open', id: 'contextOpen' },
  newTab: { label: 'Open in New Tab', id: 'contextNewTab' },
  copyLink: { label: 'Copy Link', id: 'contextCopyLink' },
  cut: { label: 'Cut', id: 'searchCut' },
  copy: { label: 'Copy', id: 'searchCopy' },
  paste: { label: 'Paste', id: 'searchPaste' },
  selectAll: { label: 'Select All', id: 'searchSelectAll' },
  clear: { label: 'Clear', id: 'searchClear' },
  refresh: { label: 'Refresh', id: 'pageRefresh' },
  copyUrl: { label: 'Copy Page URL', id: 'pageCopyUrl' }
};

const contextMenus = {
  shortcut: ['edit', 'divider', 'newTab', 'copyLink'],
  engine: ['edit', 'divider', 'open', 'newTab', 'copyLink'],
  search: ['cut', 'copy', 'paste', 'divider', 'selectAll', 'clear'],
  page: ['refresh', 'copyUrl']
};

const setDisabledStates = (states) => {
  Object.entries(states).forEach(([id, disabled]) => {
    document.getElementById(id)?.classList.toggle('disabled', disabled);
  });
};

const showContextMenu = (type, x, y, data = null) => {
  el.contextMenu.classList.remove('show');
  currentContextType = type;
  currentContextData = data;
  
  const items = contextMenus[type];
  
  el.contextMenu.innerHTML = items.map(item => {
    if (item === 'divider') {
      return '<div class="context-menu-divider"></div>';
    }
    const menuItem = contextMenuItems[item];
    return `<div class="context-menu-item" id="${menuItem.id}">${menuItem.label}</div>`;
  }).join('');
  
  if (type === 'search') {
    const hasSelection = el.searchInput.selectionStart !== el.searchInput.selectionEnd;
    const hasValue = el.searchInput.value.length > 0;
    setDisabledStates({
      searchCut: !hasSelection,
      searchCopy: !hasSelection,
      searchSelectAll: !hasValue,
      searchClear: !hasValue
    });
  }
  
  el.contextMenu.style.left = `${x}px`;
  el.contextMenu.style.top = `${y}px`;
  el.contextMenu.classList.add('show');
};

const getContextUrl = () => {
  if (currentContextType === 'shortcut') return currentContextData?.dataset.url;
  if (currentContextType === 'engine') return getBaseUrl(getEngineUrl(currentContextData));
  return null;
};

const handleContextAction = (action) => (e) => {
  e.stopPropagation();
  action();
  el.contextMenu.classList.remove('show');
};

const replaceSelection = (input, newText) => {
  const start = input.selectionStart;
  const end = input.selectionEnd;
  input.value = input.value.substring(0, start) + newText + input.value.substring(end);
  input.setSelectionRange(start + newText.length, start + newText.length);
};

el.searchForm.addEventListener('submit', e => {
  e.preventDefault();
  const query = el.searchInput.value.trim();
  if (!query) return;
  
  const url = isUrl(query) 
    ? (query.startsWith('http') ? query : `https://${query}`)
    : getEngineUrl(activeEngine) + encodeURIComponent(query);
  
  window.location.href = url;
});

el.engineToggle.addEventListener('click', e => {
  const btn = e.target.closest('.btn-toggle');
  if (!btn) return;
  
  activeEngine = btn.dataset.engine;
  el.engineToggle.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
});

document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement !== el.searchInput) {
    e.preventDefault();
    el.searchInput.focus();
  } else if (e.key === 'Escape') {
    el.searchInput.value = '';
    el.searchInput.blur();
    closeAllModals();
  }
});

document.addEventListener('contextmenu', e => {
  const shortcut = e.target.closest('.shortcut');
  const engineBtn = e.target.closest('.btn-toggle');
  const searchInput = e.target.closest('.search-input');
  
  if (shortcut) {
    e.preventDefault();
    showContextMenu('shortcut', e.pageX, e.pageY, shortcut);
  } else if (engineBtn) {
    e.preventDefault();
    showContextMenu('engine', e.pageX, e.pageY, engineBtn.dataset.engine);
  } else if (searchInput) {
    e.preventDefault();
    showContextMenu('search', e.pageX, e.pageY);
  } else {
    e.preventDefault();
    showContextMenu('page', e.pageX, e.pageY);
  }
});

document.addEventListener('click', e => {
  // Close context menu
  if (!e.target.closest('.context-menu')) {
    el.contextMenu.classList.remove('show');
  }
  
  // Close modal on backdrop click
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});

el.contextMenu.addEventListener('click', e => {
  const item = e.target.closest('.context-menu-item');
  if (!item || item.classList.contains('disabled')) return;
  
  const id = item.id;
  
  handleContextAction(() => {
    switch(id) {
      case 'contextEdit':
        if (currentContextType === 'shortcut' && currentContextData) {
          const index = parseInt(currentContextData.dataset.index);
          openEditModal(index);
        } else if (currentContextType === 'engine' && currentContextData) {
          const index = currentEngines.findIndex(e => e.name === currentContextData);
          if (index >= 0) openEditEngineModal(index);
        }
        break;
      case 'contextOpen':
        const openUrl = getContextUrl();
        if (openUrl) window.location.href = openUrl;
        break;
      case 'contextNewTab':
        const newTabUrl = getContextUrl();
        if (newTabUrl) window.open(newTabUrl, '_blank');
        break;
      case 'contextCopyLink':
        const copyUrl = getContextUrl();
        if (copyUrl) navigator.clipboard.writeText(copyUrl);
        break;
      case 'searchCut':
        const start = el.searchInput.selectionStart;
        const end = el.searchInput.selectionEnd;
        navigator.clipboard.writeText(el.searchInput.value.substring(start, end));
        replaceSelection(el.searchInput, '');
        break;
      case 'searchCopy':
        navigator.clipboard.writeText(el.searchInput.value.substring(el.searchInput.selectionStart, el.searchInput.selectionEnd));
        break;
      case 'searchPaste':
        navigator.clipboard.readText().then(text => {
          replaceSelection(el.searchInput, text);
          el.searchInput.focus();
        }).catch(() => {});
        break;
      case 'searchSelectAll':
        el.searchInput.select();
        break;
      case 'searchClear':
        el.searchInput.value = '';
        el.searchInput.focus();
        break;
      case 'pageRefresh':
        window.location.reload();
        break;
      case 'pageCopyUrl':
        navigator.clipboard.writeText(window.location.href);
        break;
    }
  })(e);
});

document.getElementById('settingsBtn').addEventListener('click', () => {
  buildShortcutList();
  buildEngineList();
  el.settingsModal.classList.add('show');
});

document.getElementById('addShortcutBtn').addEventListener('click', () => openEditModal(-1));
document.getElementById('addEngineBtn').addEventListener('click', () => openEditEngineModal(-1));

document.getElementById('saveShortcutBtn').addEventListener('click', () => saveItem('shortcut'));
document.getElementById('saveEngineBtn').addEventListener('click', () => saveItem('engine'));

document.getElementById('cancelEditBtn').addEventListener('click', () => el.editShortcutModal.classList.remove('show'));
document.getElementById('cancelEditEngineBtn').addEventListener('click', () => el.editEngineModal.classList.remove('show'));

el.shortcutList.addEventListener('click', e => {
  const editBtn = e.target.closest('.edit');
  const deleteBtn = e.target.closest('.delete');
  
  if (editBtn) {
    openEditModal(parseInt(editBtn.dataset.index));
  } else if (deleteBtn) {
    currentEdit = { type: 'shortcut', index: parseInt(deleteBtn.dataset.index) };
    el.deleteModal.classList.add('show');
  }
});

el.engineList.addEventListener('click', e => {
  const editBtn = e.target.closest('.edit-engine');
  const deleteBtn = e.target.closest('.delete-engine');
  
  if (editBtn) {
    openEditEngineModal(parseInt(editBtn.dataset.index));
  } else if (deleteBtn) {
    currentEdit = { type: 'engine', index: parseInt(deleteBtn.dataset.index) };
    el.deleteModal.classList.add('show');
  }
});

el.iconPickerToggle.addEventListener('click', () => {
  el.iconPickerPanel.classList.toggle('hidden');
  el.iconPickerToggle.classList.toggle('active');
});

el.iconPickerPanel.addEventListener('click', e => {
  const tile = e.target.closest('.icon-tile');
  if (tile) el.editIcon.value = tile.textContent;
});

document.getElementById('confirmDeleteBtn').addEventListener('click', deleteItem);

document.getElementById('cancelDeleteBtn').addEventListener('click', () => el.deleteModal.classList.remove('show'));

const buildIconGrid = (iconArray, containerId) => {
  document.getElementById(containerId).innerHTML = iconArray.map(icon => 
    `<div class="icon-tile">${icon}</div>`
  ).join('');
};

buildIconGrid(icons.emojis, 'emojiGrid');
buildIconGrid(icons.symbols, 'symbolsGrid');

buildShortcuts();
rebuildEngineToggles();
updateDate();
el.searchInput.focus();
</script>
</body>
</html>
